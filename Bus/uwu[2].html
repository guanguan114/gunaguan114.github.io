<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>公交调度游戏 - 可视化版</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
      --success-color: #2ecc71;
      --transfer-color: #f39c12; /* 换乘站颜色 */
      --terminal-color: #9b59b6; /* 终点站颜色 */
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
      color: var(--secondary-color);
      line-height: 1.6;
    }
    
    h1 {
      color: var(--primary-color);
      margin-bottom: 30px;
      text-shadow: var(--shadow);
    }
    
    #gameContainer {
      max-width: 1000px;
      margin: 0 auto;
      background-color: white;
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 20px;
    }
    
    .money-display {
      background-color: #e8f4fd;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
      display: inline-block;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .money-display i {
      color: #f39c12;
      margin-right: 8px;
    }
    
    .controls-panel {
      background-color: var(--light-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      justify-content: center;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    label {
      font-weight: 500;
      color: var(--dark-color);
    }
    
    input[type="text"], input[type="number"] {
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: var(--transition);
    }
    
    input[type="text"]:focus, input[type="number"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition);
    }
    
    button:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    select {
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      background-color: white;
      transition: var(--transition);
    }
    
    select:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    #gameCanvas {
      border: 1px solid #ccc;
      display: block;
      margin: 0 auto;
      background-color: #fafafa;
      border-radius: 8px;
      cursor: crosshair;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .line-status {
      margin-left: 10px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .line-has-bus {
      background-color: rgba(46, 204, 113, 0.2);
      color: var(--success-color);
    }
    
    .line-no-bus {
      background-color: rgba(231, 76, 60, 0.2);
      color: var(--accent-color);
    }
    
    .bus-type-info {
      font-size: 12px;
      color: #666;
      margin-left: 5px;
    }
    
    .bus-control-actions {
      display: flex;
      gap: 10px;
    }
    
    .info-text {
      margin-top: 15px;
      font-size: 14px;
      color: #666;
      font-style: italic;
    }
    
    .profit-popup {
      position: absolute;
      color: #27ae60;
      font-weight: bold;
      pointer-events: none;
      animation: floatUp 1.5s ease-out forwards;
    }
    
    @keyframes floatUp {
      0% {
        opacity: 1;
        transform: translateY(0);
      }
      100% {
        opacity: 0;
        transform: translateY(-30px);
      }
    }
    
    @media (max-width: 768px) {
      .controls-panel {
        flex-direction: column;
        align-items: stretch;
      }
      
      .control-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      .bus-control-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      #gameCanvas {
        width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <h1>公交调度游戏 <i class="fas fa-bus-alt"></i></h1>
    
    <div class="money-display">
      <i class="fas fa-coins"></i> 当前资金: <span id="moneyAmount">100</span> 敝司
    </div>
    
    <div class="controls-panel">
      <div class="control-group">
        <label for="stationName">命名新的公交站：</label>
        <input type="text" id="stationName" placeholder="请输入公交站名">
        <button onclick="addStation()"><i class="fas fa-plus-circle"></i> 添加公交站</button>
      </div>
      
      <div class="control-group">
        <label for="lineSelect">选择线路：</label>
        <select id="lineSelect" onchange="updateSelectedLine()">
          <option value="-1">新建线路</option>
        </select>
        <span id="lineBusStatus" class="line-status line-no-bus">无公交车</span>
      </div>
      
      <div class="control-group">
        <label for="lineFare">线路票价：</label>
        <input type="number" id="lineFare" min="1" value="2" placeholder="设置票价">
        <button onclick="setLineFare()"><i class="fas fa-ticket-alt"></i> 应用票价</button>
      </div>
      
      <div class="control-group">
        <label for="busSelect">选择公交车：</label>
        <select id="busSelect" onchange="updateBusTypeSelection()">
          <option value="-1">新建公交车</option>
        </select>
        <label for="busType">车型：</label>
        <select id="busType" onchange="updateBusButtonStates()">
          <option value="standard">标准型 (100敝司)</option>
          <option value="large">扩容型 (200敝司)</option>
          <option value="speed">快速型 (150敝司)</option>
          <option value="extraspeed">豪华型 (400敝司)</option>
        </select>
        <div class="bus-control-actions">
          <button onclick="addOrUpdateBus()" id="addBusBtn"><i class="fas fa-bus"></i> 添加公交车</button>
          <button onclick="removeBus()" id="removeBusBtn" disabled><i class="fas fa-trash"></i> 移除</button>
        </div>
        <span id="busCostInfo" class="bus-type-info">当前车型价格：100敝司</span>
      </div>
      
      <div class="control-group">
        <button onclick="saveState()"><i class="fas fa-save"></i> 保存状态</button>
      </div>
    </div>
    
    <canvas id="gameCanvas" width="900" height="600"></canvas>
    
    <p class="info-text">提示：只要有足够资金，可随时购买新公交车或更换已有公交车的车型。左键点击画布添加公交站，右键点击公交站可设置为换乘站或终点站。</p>
  </div>

  <script>
    let stations = [];
    let lines = [
      { id: 0, stations: [], color: getRandomColor(), fare: 2 }, 
      { id: 1, stations: [], color: getRandomColor(), fare: 2 }
    ];
    let buses = [];
    let ctx;
    let selectedLineId = 1; // 默认选择线路1
    let selectedBusId = -1; // 默认选中"新建公交车"
    let money = 100; // 玩家资金，单位：敝司，开局100
    let profitPopups = []; // 利润提示动画

    // 公交车类型配置（价格不同）
    const BASE_PASS_INTERVAL = 5000; // 基础乘客生成间隔
    const BUS_TYPES = {
      standard: { speed: 1, capacity: 30, name: "标准型", cost: 100, sellValue: 50 },
      large: { speed: 0.8, capacity: 60, name: "扩容型", cost: 200, sellValue: 100 },
      speed: { speed: 2.1, capacity: 12, name: "快速型", cost: 150, sellValue: 75 },
      extraspeed: { speed: 1.7, capacity: 45,name: "豪华型", cost: 400 , sellvalue: 250}
    };

    document.addEventListener("DOMContentLoaded", () => {
      const canvas = document.getElementById("gameCanvas");
      ctx = canvas.getContext("2d");

      // 每秒更新画面 (60fps)
      setInterval(update, 1000 / 60);

      // 定时生成乘客
      setInterval(generatePassengers, calculatePassInterval());

      canvas.addEventListener('click', (event) => {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        addStationAt(x, y);
      });

      canvas.addEventListener('contextmenu', (event) => {
        event.preventDefault(); // 阻止默认的右键菜单
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        editStationOptions(x, y);
      });

      // 初始化线路选择器和公交车按钮状态
      updateLineSelector();
      updateBusSelector();
      updateBusButtonStates();
      updateMoneyDisplay();
    });

    // 更新资金显示
    function updateMoneyDisplay() {
      document.getElementById("moneyAmount").textContent = money.toFixed(1);
    }

    // 更新公交车选择器
    function updateBusSelector() {
      const busSelect = document.getElementById("busSelect");
      const currentValue = busSelect.value;
      
      busSelect.innerHTML = '<option value="-1">新建公交车</option>';
      
      // 获取当前线路的公交车
      const lineBuses = buses.filter(bus => bus.lineId === selectedLineId);
      
      lineBuses.forEach(bus => {
        const busInfo = BUS_TYPES[bus.type];
        const option = document.createElement("option");
        option.value = bus.id;
        option.textContent = `#${bus.id} (${busInfo.name})`;
        busSelect.appendChild(option);
      });
      
      // 保持之前的选择
      if (currentValue === "-1" || lineBuses.some(bus => bus.id.toString() === currentValue)) {
        busSelect.value = currentValue;
      } else {
        busSelect.value = "-1";
        selectedBusId = -1;
      }
      
      updateBusTypeSelection();
      updateBusButtonStates();
    }

    // 更新选中的公交车类型
    function updateBusTypeSelection() {
      const busSelect = document.getElementById("busSelect");
      selectedBusId = parseInt(busSelect.value);
      
      if (selectedBusId !== -1) {
        const bus = buses.find(b => b.id === selectedBusId);
        if (bus) {
          document.getElementById("busType").value = bus.type;
        }
      }
      
      updateBusButtonStates();
    }

    // 更新公交车按钮状态
    function updateBusButtonStates() {
      const selectedBusType = document.getElementById("busType").value;
      const busCost = BUS_TYPES[selectedBusType].cost;
      const isNewBus = selectedBusId === -1;
      
      // 更新价格提示
      document.getElementById("busCostInfo").textContent = 
        isNewBus ? `购买价格：${busCost}敝司` : 
        `更换价格：${Math.max(0, busCost - BUS_TYPES[getCurrentBusType()].sellValue)}敝司`;
      
      // 计算所需资金
      let requiredFunds = isNewBus ? busCost : 
        Math.max(0, busCost - BUS_TYPES[getCurrentBusType()].sellValue);
      
      // 更新添加/更新按钮状态
      const addBtn = document.getElementById("addBusBtn");
      const hasEnoughStations = lines[selectedLineId]?.stations.length >= 2;
      
      addBtn.disabled = money < requiredFunds || !hasEnoughStations;
      addBtn.textContent = isNewBus ? "添加公交车" : "更换车型";
      addBtn.innerHTML = isNewBus ? 
        '<i class="fas fa-bus"></i> 添加公交车' : 
        '<i class="fas fa-exchange-alt"></i> 更换车型';
      
      // 更新移除按钮状态
      document.getElementById("removeBusBtn").disabled = selectedBusId === -1;
      
      // 设置按钮提示
      if (addBtn.disabled) {
        if (!hasEnoughStations) {
          addBtn.title = "线路需要至少2个站点才能添加公交车";
        } else {
          addBtn.title = `资金不足，需要${requiredFunds}敝司，当前只有${money.toFixed(1)}敝司`;
        }
      } else {
        addBtn.title = isNewBus ? "添加新公交车到当前线路" : "更换选中公交车的车型";
      }
    }

    // 获取当前选中公交车的类型
    function getCurrentBusType() {
      if (selectedBusId === -1) return document.getElementById("busType").value;
      
      const bus = buses.find(b => b.id === selectedBusId);
      return bus ? bus.type : document.getElementById("busType").value;
    }

    // 添加或更新公交车
    function addOrUpdateBus() {
      const selectedBusType = document.getElementById("busType").value;
      const busInfo = BUS_TYPES[selectedBusType];
      const isNewBus = selectedBusId === -1;
      
      // 计算费用
      let cost = isNewBus ? busInfo.cost : 
        Math.max(0, busInfo.cost - BUS_TYPES[getCurrentBusType()].sellValue);
      
      // 检查资金
      if (money < cost) {
        alert(`资金不足！需要${cost}敝司，当前只有${money.toFixed(1)}敝司。`);
        return;
      }
      
      // 检查线路是否有足够站点
      if (lines[selectedLineId].stations.length < 2) {
        alert("线路需要至少2个站点才能添加公交车！");
        return;
      }
      
      if (isNewBus) {
        // 添加新公交车
        const newBusId = generateBusId();
        const startStation = stations.find(s => s.id === lines[selectedLineId].stations[0]);
        
        buses.push({
          id: newBusId,
          x: startStation.x,
          y: startStation.y,
          passengers: 0,
          lineId: selectedLineId,
          targetIndex: 0,
          type: selectedBusType,
          passengersList: {}
        });
        
        // 扣除费用
        money -= cost;
        addProfitPopup(startStation.x, startStation.y, cost, true);
        alert(`已花费${cost}敝司购买${busInfo.name}公交车 #${newBusId}`);
      } else {
        // 更新已有公交车的类型
        const busIndex = buses.findIndex(b => b.id === selectedBusId);
        if (busIndex !== -1) {
          const oldType = buses[busIndex].type;
          const oldInfo = BUS_TYPES[oldType];
          
          // 记录当前状态
          const currentX = buses[busIndex].x;
          const currentY = buses[busIndex].y;
          const currentTarget = buses[busIndex].targetIndex;
          const currentPassengers = buses[busIndex].passengers;
          const currentPassengersList = buses[busIndex].passengersList;
          
          // 更新公交车类型
          buses[busIndex] = {
            ...buses[busIndex],
            type: selectedBusType,
            x: currentX,
            y: currentY,
            targetIndex: currentTarget,
            passengers: Math.min(currentPassengers, busInfo.capacity), // 适应新的容量
            passengersList: currentPassengersList
          };
          
          // 扣除差价
          money -= cost;
          addProfitPopup(currentX, currentY, cost, true);
          alert(`已花费${cost}敝司将公交车 #${selectedBusId} 更换为${busInfo.name}`);
        }
      }
      
      // 更新显示
      updateMoneyDisplay();
      updateBusSelector();
      updateLineBusStatus();
    }

    // 移除公交车
    function removeBus() {
      if (selectedBusId === -1) return;
      
      const bus = buses.find(b => b.id === selectedBusId);
      if (!bus) return;
      
      const busInfo = BUS_TYPES[bus.type];
      const sellValue = busInfo.sellValue;
      
      // 确认移除
      if (confirm(`确定要移除公交车 #${bus.id} (${busInfo.name}) 吗？将获得${sellValue}敝司回收款。`)) {
        // 移除公交车
        const index = buses.findIndex(b => b.id === selectedBusId);
        if (index !== -1) {
          buses.splice(index, 1);
          
          // 添加回收款
          money += sellValue;
          addProfitPopup(bus.x, bus.y, sellValue);
          updateMoneyDisplay();
          
          // 更新显示
          updateBusSelector();
          updateLineBusStatus();
          alert(`已移除公交车 #${bus.id}，获得${sellValue}敝司回收款`);
        }
      }
    }

    // 添加利润提示
    function addProfitPopup(x, y, amount, isExpense = false) {
      const prefix = isExpense ? "-" : "+";
      const color = isExpense ? "rgba(231, 76, 60, " : "rgba(39, 174, 96, ";
      
      profitPopups.push({
        x: x,
        y: y,
        amount: `${prefix}${amount}`,
        color: color,
        opacity: 1,
        timer: 0
      });
    }

    // 设置线路票价
    function setLineFare() {
      const fareInput = document.getElementById("lineFare");
      const fare = parseFloat(fareInput.value);
      
      if (isNaN(fare) || fare <= 0) {
        alert("请输入有效的票价（正数）");
        return;
      }
      
      lines[selectedLineId].fare = fare;
      alert(`线路 ${selectedLineId} 票价已设置为 ${fare} 敝司`);
    }

    // 编辑站点选项（换乘站和终点站）
    function editStationOptions(x, y) {
      const station = stations.find(s => 
        Math.pow(s.x - x, 2) + Math.pow(s.y - y, 2) <= Math.pow(15, 2)
      );
      
      if (station) {
        // 检查该站点是否是任何线路的终点站
        const isTerminalOfAnyLine = lines.some(line => 
          line.stations.length > 0 && line.stations[line.stations.length - 1] === station.id
        );
        
        let options = "1. 修改名称\n";
        options += station.isTransfer ? "2. 取消换乘站\n" : "2. 设为换乘站\n";
        options += isTerminalOfAnyLine ? "3. 取消终点站\n" : "3. 设为当前线路终点站";
        
        const action = prompt(
          `当前站点: ${station.name}\n${options}`,
          "请输入1-3选择操作"
        );
        
        if (action === "1") {
          const newName = prompt("请输入新的公交站名:", station.name);
          if (newName && newName.trim()) {
            station.name = newName.trim();
          }
        } else if (action === "2") {
          station.isTransfer = !station.isTransfer;
          alert(`${station.name}已${station.isTransfer ? '设为换乘站' : '取消换乘站'}`);
          
          // 如果设为换乘站，自动连接到其他线路的换乘站
          if (station.isTransfer) {
            connectTransferStations(station);
          }
        } else if (action === "3") {
          if (isTerminalOfAnyLine) {
            // 取消终点站状态
            lines.forEach(line => {
              if (line.stations.length > 0 && line.stations[line.stations.length - 1] === station.id) {
                line.stations.pop(); // 移除终点站
              }
            });
            alert(`${station.name}已取消终点站状态`);
          } else {
            // 设为当前线路终点站
            if (lines[selectedLineId].stations.includes(station.id)) {
              // 如果站点已在线路中，移动到最后作为终点站
              const index = lines[selectedLineId].stations.indexOf(station.id);
              lines[selectedLineId].stations.splice(index, 1);
              lines[selectedLineId].stations.push(station.id);
            } else {
              // 添加到线路末尾作为终点站
              lines[selectedLineId].stations.push(station.id);
            }
            alert(`${station.name}已设为线路${selectedLineId}的终点站`);
          }
        }
        renderStations();
        updateBusButtonStates(); // 可能影响线路站点数量
      }
    }

    // 连接所有换乘站
    function connectTransferStations(newTransferStation) {
      // 找到所有其他换乘站
      const otherTransferStations = stations.filter(s => s.isTransfer && s.id !== newTransferStation.id);
      
      // 将新换乘站添加到包含其他换乘站的线路
      otherTransferStations.forEach(transferStation => {
        lines.forEach(line => {
          if (line.stations.includes(transferStation.id) && !line.stations.includes(newTransferStation.id)) {
            line.stations.push(newTransferStation.id);
          }
        });
      });
      
      // 将其他换乘站添加到当前线路
      otherTransferStations.forEach(transferStation => {
        if (!lines[selectedLineId].stations.includes(transferStation.id)) {
          lines[selectedLineId].stations.push(transferStation.id);
        }
      });
      
      alert(`已自动连接所有换乘站，实现线路互通`);
      updateBusButtonStates();
    }

    function addStation() {
      const stationName = document.getElementById("stationName").value.trim();
      if (!stationName) {
        alert("公交站名称不能为空！");
        return;
      }

      // 随机位置添加公交站
      const x = Math.random() * 800 + 50;
      const y = Math.random() * 500 + 50;

      addStationAt(x, y, stationName);
      
      // 清空输入框
      document.getElementById("stationName").value = "";
    }

    function addStationAt(x, y, name = "新站") {
      const newStation = { 
        id: stations.length, 
        name, 
        x, 
        y, 
        passengers: 0,
        waitingPassengers: {}, // 记录等待前往其他站点的乘客
        transferPassengers: {}, // 记录等待换乘的乘客
        isTransfer: false // 是否为换乘站
      };
      stations.push(newStation);

      if (selectedLineId >= 0) {
        lines[selectedLineId].stations.push(newStation.id);
      }

      renderStations();
      updateLineSelector();
      updateBusButtonStates();
    }

    function renderStations() {
      // 清除画布并绘制背景
      ctx.clearRect(0, 0, 900, 600);
      ctx.fillStyle = "#f9f9f9";
      ctx.fillRect(0, 0, 900, 600);

      // 绘制线路
      lines.slice(1).forEach(line => { // 跳过线路0
        if (line.stations.length < 2) return;
        
        ctx.beginPath();
        line.stations.forEach((stationId, index) => {
          const station = stations.find(s => s.id === stationId);
          if (index === 0) {
            ctx.moveTo(station.x, station.y);
          } else {
            ctx.lineTo(station.x, station.y);
          }
        });
        
        // 添加线路箭头指示方向
        if (line.stations.length >= 2) {
          const lastStation = stations.find(s => s.id === line.stations[line.stations.length - 1]);
          const prevStation = stations.find(s => s.id === line.stations[line.stations.length - 2]);
          const angle = Math.atan2(lastStation.y - prevStation.y, lastStation.x - prevStation.x);
          
          ctx.save();
          ctx.translate(lastStation.x, lastStation.y);
          ctx.rotate(angle);
          ctx.moveTo(0, 0);
          ctx.lineTo(-15, 5);
          ctx.lineTo(-15, -5);
          ctx.restore();
        }
        
        ctx.lineWidth = 4; // 设置线条宽度
        ctx.strokeStyle = line.color;
        ctx.stroke();
        
        // 绘制线路ID和票价标签
        if (line.stations.length > 0) {
          const firstStation = stations.find(s => s.id === line.stations[0]);
          ctx.fillStyle = line.color;
          ctx.font = "bold 14px sans-serif";
          ctx.fillText(`线路 ${line.id} (票价: ${line.fare}敝司)`, firstStation.x - 40, firstStation.y - 20);
        }
      });

      // 绘制公交站
      stations.forEach(station => {
        // 绘制站台底座
        ctx.beginPath();
        ctx.arc(station.x, station.y, 12, 0, Math.PI * 2);
        ctx.fillStyle = "#e0e0e0";
        ctx.fill();
        
        // 绘制站台（换乘站和终点站用不同颜色）
        let stationColor = "blue";
        if (station.isTransfer) {
          stationColor = "#f39c12"; // 换乘站橙色
        } else {
          // 检查是否是任何线路的终点站
          const isTerminal = lines.some(line => 
            line.stations.length > 0 && line.stations[line.stations.length - 1] === station.id
          );
          if (isTerminal) {
            stationColor = "#9b59b6"; // 终点站紫色
          }
        }
        
        ctx.beginPath();
        ctx.arc(station.x, station.y, 10, 0, Math.PI * 2);
        ctx.fillStyle = stationColor;
        ctx.fill();
        
        // 标记换乘站
        if (station.isTransfer) {
          ctx.beginPath();
          ctx.arc(station.x, station.y, 15, 0, Math.PI * 2);
          ctx.strokeStyle = "#f39c12";
          ctx.lineWidth = 2;
          ctx.setLineDash([3, 3]);
          ctx.stroke();
          ctx.setLineDash([]); // 重置虚线
          
          // 绘制换乘图标
          ctx.fillStyle = "#f39c12";
          ctx.font = "16px FontAwesome";
          ctx.fillText("\uf0ec", station.x - 8, station.y + 6);
        }
        
        // 标记终点站
        const isTerminal = lines.some(line => 
          line.stations.length > 0 && line.stations[line.stations.length - 1] === station.id
        );
        if (isTerminal && !station.isTransfer) {
          // 绘制终点站标识
          ctx.beginPath();
          ctx.moveTo(station.x - 10, station.y - 10);
          ctx.lineTo(station.x + 10, station.y + 10);
          ctx.moveTo(station.x + 10, station.y - 10);
          ctx.lineTo(station.x - 10, station.y + 10);
          ctx.strokeStyle = "white";
          ctx.lineWidth = 2;
          ctx.stroke();
        }
        
        // 绘制站台名称和乘客数
        ctx.fillStyle = "black";
        ctx.font = "13px sans-serif";
        ctx.fillText(station.name, station.x + 15, station.y);
        
        // 显示总乘客数（包括等待换乘的）
        const totalPassengers = station.passengers + 
          Object.values(station.transferPassengers).reduce((sum, val) => sum + val, 0);
        ctx.fillText(`乘客: ${totalPassengers}`, station.x + 15, station.y + 20);
        
        // 如果有乘客，绘制乘客图标
        if (totalPassengers > 0) {
          ctx.fillStyle = "#e74c3c";
          ctx.beginPath();
          ctx.arc(station.x - 15, station.y, 5, 0, Math.PI * 2);
          ctx.fill();
        }
      });

      // 绘制公交车
      buses.forEach(bus => {
        const busInfo = BUS_TYPES[bus.type];
        const busColor = lines[bus.lineId].color;
        
        // 绘制公交车
        ctx.save();
        ctx.translate(bus.x, bus.y);
        ctx.rotate(getAngleToNextStation(bus));
        
        // 绘制巴士形状
        ctx.fillStyle = busColor;
        ctx.fillRect(-12, -8, 24, 16); // 车身
        ctx.fillStyle = "white";
        ctx.fillRect(-8, -6, 6, 4); // 窗户
        ctx.fillRect(2, -6, 6, 4); // 窗户
        
        // 显示公交车ID
        ctx.fillStyle = "black";
        ctx.font = "8px sans-serif";
        ctx.fillText(`#${bus.id}`, 0, -10);
        
        ctx.restore();
        
        // 显示公交车信息
        ctx.fillStyle = "black";
        ctx.font = "11px sans-serif";
        ctx.fillText(`${busInfo.name}`, bus.x - 15, bus.y - 15);
        ctx.fillText(`乘客: ${bus.passengers}/${busInfo.capacity}`, bus.x - 25, bus.y + 25);
      });

      // 绘制利润提示动画
      drawProfitPopups();
    }

    // 绘制利润提示动画
    function drawProfitPopups() {
      profitPopups.forEach(popup => {
        ctx.fillStyle = `${popup.color}${popup.opacity})`;
        ctx.font = "14px sans-serif";
        ctx.fillText(`${popup.amount} 敝司`, popup.x, popup.y);
      });
    }

    function getAngleToNextStation(bus) {
      const currentStation = stations.find(s => s.id === lines[bus.lineId].stations[bus.targetIndex]);
      const nextStationId = lines[bus.lineId].stations[(bus.targetIndex + 1) % lines[bus.lineId].stations.length];
      const nextStation = stations.find(s => s.id === nextStationId);
      const dx = nextStation.x - currentStation.x;
      const dy = nextStation.y - currentStation.y;
      return Math.atan2(dy, dx);
    }

    function update() {
      moveBuses();
      handleTransfers(); // 处理换乘站的乘客换乘
      updateProfitPopups();
      renderStations();
    }

    // 处理换乘站的乘客换乘
    function handleTransfers() {
      stations.forEach(station => {
        if (station.isTransfer && Object.keys(station.transferPassengers).length > 0) {
          // 检查是否有公交车到达换乘站，可以接载换乘乘客
          buses.forEach(bus => {
            const currentStationId = lines[bus.lineId].stations[bus.targetIndex];
            if (currentStationId === station.id) {
              // 公交车到达换乘站，处理换乘乘客
              const busInfo = BUS_TYPES[bus.type];
              const availableSpace = busInfo.capacity - bus.passengers;
              
              if (availableSpace > 0) {
                // 查找该线路可以到达的站点
                const reachableStations = lines[bus.lineId].stations;
                
                // 检查是否有换乘乘客的目的地在该线路上
                Object.keys(station.transferPassengers).forEach(destId => {
                  if (reachableStations.includes(parseInt(destId)) && availableSpace > 0) {
                    const transferCount = Math.min(station.transferPassengers[destId], availableSpace);
                    
                    // 转移乘客到公交车
                    if (!bus.passengersList) bus.passengersList = {};
                    if (!bus.passengersList[destId]) bus.passengersList[destId] = 0;
                    bus.passengersList[destId] += transferCount;
                    bus.passengers += transferCount;
                    
                    // 减少换乘站的换乘乘客
                    station.transferPassengers[destId] -= transferCount;
                    if (station.transferPassengers[destId] === 0) {
                      delete station.transferPassengers[destId];
                    }
                  }
                });
              }
            }
          });
        }
      });
    }

    // 更新利润提示动画
    function updateProfitPopups() {
      profitPopups.forEach((popup, index) => {
        popup.timer++;
        popup.y -= 0.5;
        if (popup.timer > 60) { // 30帧后开始淡出
          popup.opacity -= 0.05;
        }
        if (popup.opacity <= 0) {
          profitPopups.splice(index, 1);
        }
      });
    }

    function generatePassengers() {
      if (stations.length < 2) return; // 至少需要2个站点才会生成有目的地的乘客
      
      // 随机选择起点站，排除终点站
      let fromStation;
      do {
        fromStation = stations[Math.floor(Math.random() * stations.length)];
        // 检查是否是任何线路的终点站
        const isTerminal = lines.some(line => 
          line.stations.length > 0 && line.stations[line.stations.length - 1] === fromStation.id
        );
        // 如果是终点站则重新选择
        if (!isTerminal) break;
      } while (true);
      
      // 随机选择一个不同的目的站点
      let toStation;
      do {
        toStation = stations[Math.floor(Math.random() * stations.length)];
      } while (toStation.id === fromStation.id);
      
      // 记录等待前往该站点的乘客
      if (!fromStation.waitingPassengers[toStation.id]) {
        fromStation.waitingPassengers[toStation.id] = 0;
      }
      fromStation.waitingPassengers[toStation.id]++;
      fromStation.passengers++;
    }

    function moveBuses() {
      if (buses.length === 0 || stations.length === 0) return;

      for (let i = buses.length - 1; i >= 0; i--) {
        const bus = buses[i];
        if (bus.targetIndex === undefined) bus.targetIndex = 0;

        const line = lines[bus.lineId];
        if (line.stations.length === 0) continue;
        
        const currentStationId = line.stations[bus.targetIndex];
        const target = stations.find(s => s.id === currentStationId);
        const dx = target.x - bus.x;
        const dy = target.y - bus.y;
        const dist = Math.sqrt(dx * dx + dy * dy);

        // 检查是否到达目标站点
        if (dist < 5) {
          // 到达站点，处理上下客
          handlePassengerExchange(bus, currentStationId);
          
          // 检查是否是终点站
          const isLastStation = bus.targetIndex === line.stations.length - 1;
          
          if (isLastStation) {
            // 终点站处理：返回起点站重新开始
            const startStation = stations.find(s => s.id === line.stations[0]);
            bus.x = startStation.x;
            bus.y = startStation.y;
            bus.targetIndex = 0;
            continue;
          }

          // 移动到下一站
          bus.targetIndex++;
        } else {
          // 移动到下一站
          const moveRatio = BUS_TYPES[bus.type].speed / dist;
          bus.x += dx * moveRatio;
          bus.y += dy * moveRatio;
        }
      }
    }

    // 处理乘客上下车
    function handlePassengerExchange(bus, currentStationId) {
      const currentStation = stations.find(s => s.id === currentStationId);
      const line = lines[bus.lineId];
      const busInfo = BUS_TYPES[bus.type];
      
      // 1. 乘客下车：检查是否有前往当前站点的乘客
      let alightedPassengers = 0;
      if (bus.passengersList && bus.passengersList[currentStationId]) {
        alightedPassengers = bus.passengersList[currentStationId];
        bus.passengers -= alightedPassengers;
        delete bus.passengersList[currentStationId];
        
        // 每有一位乘客下车，赚取利润（基于线路票价）
        const profit = alightedPassengers * line.fare;
        if (profit > 0) {
          money += profit;
          updateMoneyDisplay();
          addProfitPopup(currentStation.x, currentStation.y, profit.toFixed(1));
          updateBusButtonStates(); // 资金变化，更新按钮状态
        }
      }
      
      // 2. 乘客上车：搭载前往后续站点的乘客或需要换乘的乘客
      const availableSpace = busInfo.capacity - bus.passengers;
      if (availableSpace > 0) {
        // 初始化乘客列表
        if (!bus.passengersList) {
          bus.passengersList = {};
        }
        
        // 获取线路上的后续站点
        const currentIndex = line.stations.indexOf(currentStationId);
        const subsequentStations = line.stations.slice(currentIndex + 1);
        
        // 处理本站等待的乘客
        if (currentStation.waitingPassengers) {
          Object.keys(currentStation.waitingPassengers).forEach(destId => {
            const destIdNum = parseInt(destId);
            const passengerCount = currentStation.waitingPassengers[destIdNum];
            
            if (passengerCount > 0 && availableSpace > 0) {
              if (subsequentStations.includes(destIdNum)) {
                // 目的地在当前线路上，直接搭载
                const take = Math.min(passengerCount, availableSpace);
                bus.passengersList[destIdNum] = (bus.passengersList[destIdNum] || 0) + take;
                bus.passengers += take;
                currentStation.waitingPassengers[destIdNum] -= take;
                currentStation.passengers -= take;
                
                if (currentStation.waitingPassengers[destIdNum] === 0) {
                  delete currentStation.waitingPassengers[destIdNum];
                }
              } else if (currentStation.isTransfer) {
                // 目的地不在当前线路上，但当前是换乘站，乘客在此换乘
                const take = Math.min(passengerCount, availableSpace);
                bus.passengersList[currentStationId] = (bus.passengersList[currentStationId] || 0) + take;
                bus.passengers += take;
                currentStation.waitingPassengers[destIdNum] -= take;
                currentStation.passengers -= take;
                
                // 将乘客转移到换乘列表
                if (!currentStation.transferPassengers[destIdNum]) {
                  currentStation.transferPassengers[destIdNum] = 0;
                }
                currentStation.transferPassengers[destIdNum] += take;
                
                if (currentStation.waitingPassengers[destIdNum] === 0) {
                  delete currentStation.waitingPassengers[destIdNum];
                }
              }
            }
          });
        }
      }
    }

    // 生成唯一公交车ID
    function generateBusId() {
      return buses.length > 0 ? Math.max(...buses.map(b => b.id)) + 1 : 1;
    }

    // 更新线路公交车状态显示
    function updateLineBusStatus() {
      const lineBusCount = buses.filter(bus => bus.lineId === selectedLineId).length;
      const lineBusStatus = document.getElementById("lineBusStatus");
      
      if (lineBusCount > 0) {
        lineBusStatus.textContent = `有${lineBusCount}辆公交车`;
        lineBusStatus.className = "line-status line-has-bus";
      } else {
        lineBusStatus.textContent = "无公交车";
        lineBusStatus.className = "line-status line-no-bus";
      }
    }

    function updateSelectedLine() {
      const selectElement = document.getElementById("lineSelect");
      selectedLineId = parseInt(selectElement.value);
      
      if (selectedLineId === -1) {
        const newLineId = lines.length;
        lines.push({ id: newLineId, stations: [], color: getRandomColor(), fare: 2 });
        selectedLineId = newLineId;
        updateLineSelector();
      }
      
      // 更新按钮状态和票价显示
      updateLineBusStatus();
      updateBusSelector();
      document.getElementById("lineFare").value = lines[selectedLineId].fare;
    }

    function updateLineSelector() {
      const selectElement = document.getElementById("lineSelect");
      selectElement.innerHTML = '<option value="-1">新建线路</option>';
      
      lines.forEach(line => {
        const busCount = buses.filter(bus => bus.lineId === line.id).length;
        const option = document.createElement("option");
        option.value = line.id;
        option.textContent = `线路 ${line.id} (${busCount}辆公交车)`;
        selectElement.appendChild(option);
      });
      
      selectElement.value = selectedLineId.toString();
      updateLineBusStatus();
    }

    function getRandomColor() {
      // 生成明亮且适合线路显示的颜色
      const hue = Math.floor(Math.random() * 360);
      return `hsl(${hue}, 70%, 50%)`;
    }

    function calculatePassInterval() {
      const numBuses = buses.length;
      return Math.max(BASE_PASS_INTERVAL / (numBuses + 1), 1000); // 确保最小间隔为1000ms
    }

    function saveState() {
      const gameState = {
        stations: stations,
        lines: lines,
        buses: buses,
        money: money
      };
      localStorage.setItem('gameState', JSON.stringify(gameState));
      alert("游戏状态已保存！");
    }
  </script>
</body>
</html>